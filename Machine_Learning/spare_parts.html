<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Spare Parts</title>
    <script type="text/javascript" src="js/jquery-3.4.1.min.js"> </script>
    <script src="js/jspdf.debug.js"></script>
	<script src="js/jspdf.plugin.autotable.js"></script>
    <style>
      .table, #hiddenTable {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        width: 100%;
        margin-left: auto;
        margin-right: auto;
      }
      #myHead {
        margin-left: auto;
        margin-right: auto;
      }
      .table td, .table th, #hiddenTable td, #hiddenTable th {
        border: 1px solid #ddd;
        padding: auto;
        vertical-align: middle;
        text-align: center;

      }


       .table tr:nth-child(even){background-color: #f2f2f2;}

      #hiddenTable tr:nth-child(even){background-color: #f2f2f2;}

      .table tr:hover {background-color: #ddd;}

        #myTable th, #hiddenTable th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: center;
        background-color: #00AEEF;
        color: white;
      }
      div {
        text-align: center;
        margin: auto;
        width: 100%;
      }
      #searchInput {
        width: 200px;
      }
    </style>
  </head>
  <body>
    <div name="Image">
    </div>
    <div name="Search">
      <input type="text" id="searchInput" name="searchInput" title="Type in a part or part description" placeholder="Type in a part or part description" autofocus>
      <button type="button" id="searchBtn" name="searchBtn" onclick="mySearchFunction()" > Search </button>
      <br>
      <p> Select Desired Part and click Button above to add it. </p>
      <select name="myPartsList" id="myPartsList" style= "display: none" multiple>
      </select><button type="button" name="addRow" id="addRow" onclick="myNewRow()" > Add Selected Parts to a Row </button><br><br>
    </div>
    <div name="table" id="table">
        <table id="myTable" class ="table">
          <colgroup>
            <col width="5%">
              <col width="20%">
                <col width="20%">
                  <col width="10%">
                    <col width="10%">
                      <col width ="15%">
                        <col width="10%">
                          <col width="10%">
            </colgroup>
          <thead id= "myHead">
            <tr>
              <th> </th>
              <th> Part # </th>
              <th> Desc </th>
              <th> List Price </th>
              <th> Qty </th>
              <th> Amount </th>
              <th> Qty Available </th>
              <th> Lead Time </th>
            </tr>
          </thead>
            <br><br>
            <tbody id="myBody">
            </tbody>
        </table>
        <table id="myTable2" class ="table">
          <colgroup>
            <col width="80%">
              <col width="20%">
            </colgroup>
            <tbody id="myBody2" >
              <tr>
                <td>Total: </td>
                <td></td>
              </tr>
              <tr style= "display:none" >
                <td>Additional Comments: </td>
                <td></td>
              </tr>
            </tbody>
        </table>
        <br>
    </div>
    <div id ="Total">
      <p> Total Amount: </p>
      <span id = "TotalAmt"> $0.00 </span>
    </div>
    <div id="AddComments">
      <br>
      <p> Additional Comments: </p>
      <input type="text" id="commentInput" width="auto">
    </div>
    <div name="export">
      <p> Click on the X to delete the entry.  </p>
      <br>
      <button type="button" name="exportBtn" id="exportBtn" onClick="PrintElem()"> Print </button>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<button type="button" name="dloadBtn" id="dloadBtn" onClick="renderFromCode()"> Save Form as PDF </button>
      <br>
    </div>
    <div id="hiddenImg" style="display: none;">
      <h1>
        <img src="styles/Logo.jpg" alt="" height="100" width="200" align="right">
      </h1>
    <div id="hiddenDiv" style="display: none;">
      <style> #hiddenTable td, #hiddenTable th {border: 1px solid #ddd;padding: auto; vertical-align: middle;text-align: center;} #hiddenTable th {padding-top: 12px;padding-bottom: 12px;text-align: center;background-color: #00AEEF;color: white;} #hiddenTable tr:nth-child(even){background-color: #f2f2f2;} #hiddenTable {font-family: 'Trebuchet MS', Arial, Helvetica, sans-serif; border-collapse: collapse; width: 75%; margin-left: auto; margin-right: auto;}#hiddenTable td, #hiddenTable th {border: 1px solid #ddd; padding: 5px; vertical-align: middle; text-align: center;} </style>
      <table id="hiddenTable" class="table">
        <colgroup>
          <col width="5%">
            <col width="20%">
              <col width="20%">
                <col width="10%">
                  <col width="10%">
                    <col width ="15%">
                      <col width="10%">
                        <col width="10%">
        </colgroup>
        <thead>
          <tr>
            <th> Part Number </th>
            <th> Description </th>
            <th> Unit Price </th>
            <th> Quantity </th>
            <th> Amount </th>
            <th> Quantity Available </th>
            <th> Lead Time </th>
          </tr>
        </thead>
          <br><br>
          <tbody>
          </tbody>
      </table>
    </div>
    <div>
    <script type="text/javascript" >
      var csvdata = "";
      var loaded = false;

	  function renderFromCode(){
  		var doc = new jsPDF();
  		doc.setFontSize(10);
  		var results = [];
      var results2 = [];

  		var img = new Image();
  		img.addEventListener('load', function() {
  			doc.addImage(img, 'JPEG', 165, 7, 40, 20);
  			var today = new Date();
  			var dd = String(today.getDate()).padStart(2, '0');
  			var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
  			var yyyy = today.getFullYear();

  			today = mm + '_' + dd + '_' + yyyy;
  			file_name = "Bauer_Part_Form_" + today
  			doc.save(file_name);
  		});

  		var table = document.getElementById("myBody");
      var tbody = document.getElementById("myBody2");
      tbody.rows[1].cells[1].innerHTML = document.getElementById("commentInput").value;
      //var td = document.createElement("td");
      /*var tdtotal1 = document.createElement("td").appendChild(document.createTextNode("Total:"));
      totalRow.appendChild(tdtotal1);
      var tdtotal2 = document.createElement("td").appendChild(document.createTextNode(document.getElementById("TotalAmt").innerHTML));
      totalRow.appendChild(tdtotal2);
      var tdcomment1 = document.createElement("td").appendChild(document.createTextNode("Additional Comments: "));
      commentsRow.appendChild(tdcomment1);
      var tdcomment2 = document.createElement("td").appendChild(document.createTextNode(document.getElementById("commentInput").value));
      commentsRow.appendChild(tdcomment2);
      tbody.appendChild(totalRow);
      tbody.appendChild(commentsRow); */
  		var trold = table.getElementsByTagName("tr");
  		var length = trold.length;
  		for(var i = 0; i<length; i++){
  			var tds = trold[i].getElementsByTagName("td");
    			var qtyText = tds[4].childNodes[0].value;
    			var amtText = tds[5].childNodes[0].innerHTML;
    			results.push({
    				field1: tds[1].innerHTML,
    				field2: tds[2].innerHTML,
    				field3: tds[3].innerHTML,
    				field4: qtyText,
    				field5: amtText,
    				field6: tds[6].innerHTML,
    				field7: tds[7].innerHTML
    			});
  		}
      results2.push({
        field1: "Total",
        field2: document.getElementById("TotalAmt").innerHTML
      });
      results2.push({
        field1: "Additional Comments",
        field2: document.getElementById("commentInput").value
      });
  		doc.autoTable([
  		  {title: "Part Number",  dataKey: "field1"},
  		  {title: "Description",  dataKey: "field2"},
  		  {title: "Unit Price",  dataKey: "field3"},
  		  {title: "Qty",  dataKey: "field4"},
  		  {title: "Amount",  dataKey: "field5"},
  		  {title: "Quantity Available",  dataKey: "field6"},
  		  {title: "Lead Time",  dataKey: "field7"}
  		],
  		results, {
  		  startY: 30,
  		  headerStyles: {fillColor: [51, 122, 183]},
  		  theme: 'grid',
  		  margin: {horizontal: 7},
  		  styles: {overflow: 'linebreak'},
  		  columnStyles: {text: {columnWidth: 'wrap'}},
  		});
      doc.autoTable([
  		  {title: "",  dataKey: "field1"},
  		  {title: "",  dataKey: "field2"}
  		], results2, {
      startY: doc.autoTableEndPosY()
      });

  		doc.save("Bauer_Part_Form");
  		img.src = 'https://www.bauer-connect.com/spareparts/styles/Logo.jpg';
      tbody.deleteRow(-1);
  	}


      function opsi(data){
        var allRows = data.split(/\r?\n|\r/);
        csvdata = allRows;
        loaded = true;
      }

      $.ajax({
          url: "spareparts.csv",
          // url: "My_Spare_parts.php?key="$.(#myInput).txtValue,
          dataType: "text",
          crossOrigin: null
      }).done(opsi);

      function mySearchFunction() {
        listold = document.getElementById("myPartsList");
        var listparent = listold.parentNode;
        listold.parentNode.removeChild(listold);
        var input, filter, i, keylen, part_no, desc, price, avail_qty, lead_time, value;
        list = document.createElement("select");
        list.multiple = "multiple";
        list.id = "myPartsList";
        input = document.getElementById("searchInput");
        filter = input.value.toUpperCase();
        keylen = input.value.length;
        if(keylen>2) {
          for (i = 1; i < csvdata.length; i++) {
            var cells = csvdata[i].split(',');
            for(j=0; j < 2; j++) {
              var td = cells[j];
              if (td) {
                if (td.toUpperCase().indexOf(filter) > -1) {
                  part_no = cells[0];
                  desc = cells[1];
                  var numb = cells[2];
                  if(isNaN(numb)) {
                    price = numb;
                  } else {
                    price = parseFloat(numb).toFixed(2);
                  }
                  avail_qty = cells[3];
                  lead_time = cells[4];
                  value = part_no + "," + desc + "," + price + "," + avail_qty + "," + lead_time;
                  var description = "Part Number: " +part_no+ "|    |" + "Description: " + desc;
                  var option = document.createElement("option");
                  option.value = value;
                  option.text = description;
                  option.ondblclick = (function() {myNewRow()});
                  list.appendChild(option);
                  if( j=== 0) {break;}
                } else {
             }
            }
           }
         }
         listparent.appendChild(list);
         list_focus();
        } else {
          alert("Search string must contain at least three characters!")
        }
      }

      document.addEventListener("keyup", function(event) {
        var selected_list = document.getElementById("myPartsList");
        var input = document.getElementById("searchInput");
        if(event.keyCode === 13) {
          if(document.activeElement === input){
            document.getElementById("searchBtn").click();
          }
          else if(document.activeElement === selected_list){
            myNewRow();
          }
        }
      });
      function myNewRow() {
        list = document.getElementById("myPartsList");
        var tbody = document.getElementById("myBody");
        for(var i=0; i<list.length; i++) {
          if (list[i].selected) {
              var text = list[i].value;
              var cells = text.split(',')
              var tr = document.createElement("tr");
              tr.id = "row" + cells[0];
              for(var j=0; j<8; j++) {
                var td = document.createElement("td");
                if(j==0) {
                  btn = document.createElement("button");
                  btn.id= "btn4" +cells[0];
                  btn.onclick = (function(rowid){return function(){byeRow(rowid);}})(cells[0]);
                  btn.innerHTML = "X";
                  td.appendChild(btn);
                }
                else if(j==1) {
                  part_no = document.createTextNode(cells[0]);
                  part_no.id = cells[0];
                  td.appendChild(part_no);
                }
                else if(j==2){
                  desc = document.createTextNode(cells[1]);
                  td.appendChild(desc);
                }
                else if (j==3) {
					if (isNaN(cells[2])){
						priceStr = cells[2];
					} else {
						priceStr = "$"+cells[2];
					}
                  price = document.createTextNode(priceStr);
                  td.id = "price4"+cells[0];
                  td.appendChild(price);
                }
                else if(j==4) {
                  qty = document.createElement("input");
                  id= "qty4" +cells[0];
                  qty.id = id;
                  qty.type = "input";
                  qty.value = "";
                  qty.class = "quantity";
                  qty.style.width = "15px";
                  qty.onkeyup = (function(cellid){
                                   return function(){qtyCalc(cellid);}})(cells[0]);
                  td.appendChild(qty);
                }
                else if(j==5) {
                  amount = document.createElement("span");
                  amount.id = "amt4" + cells[0];
                  td.appendChild(amount);
                }
                else if(j==6) {
                  qty_onhand = document.createTextNode(cells[3]);
                  td.id = "qty_avail4"+cells[0];
                  td.appendChild(qty_onhand);
                }
                else if (j==7) {
                  lead_time = document.createTextNode(cells[4]);
                  td.id = "lead4"+cells[0];
                  td.style.visibility = "hidden";
                  td.appendChild(lead_time)
                }
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
          }
        }
      }
      function PrintElem() {
            var divhidden = document.getElementById("hiddenDiv");
            var tablehid = document.getElementById("hiddenTable");
            var body = document.createElement('tbody');
            var totaldiv = document.getElementById("Total").cloneNode(true);
            totaldiv.id = "cloneTotaldiv";
            //var commentDiv = document.getElementById("AddComments").cloneNode(true);
            var commentinput = document.getElementById("commentInput");
            var commentvalue = commentinput.value;
            var commentparent = commentInput.parentNode.cloneNode(true);
            var newcomment = commentparent.getElementsByTagName("input")[0];
            commentparent.removeChild(newcomment);
            var commentchild = document.createTextNode(commentvalue);
            commentparent.appendChild(commentchild);
            commentparent.id = "clonecommentdiv";
            body.id = "hiddenbody";
            var table = document.getElementById("myBody");
            var trold = table.getElementsByTagName("tr");
            var length = trold.length;
            for(var i = 0; i<length; i++){
                  var tr = document.createElement("tr");
                  var tds = trold[i].getElementsByTagName("td");
                  for(var j=1; j<8; j++) {
                    var td = tds[j].cloneNode(true);
                    if (j==1 || j==2 || j==3 || j==5 || j==6 || j==7) {
                      tr.appendChild(td);
                    }
                    else if(j==4) {
                      var tdinput = td.childNodes[0];
                      var text = tdinput.value;
                      var parent = tdinput.parentNode;
                      tdinput.parentNode.removeChild(tdinput);
                      var child = document.createTextNode(text);
                      parent.appendChild(child);
                      tr.appendChild(parent);
                    }
                  }
                  body.appendChild(tr);
            tablehid.appendChild(body);
            divhidden.appendChild(tablehid);
            divhidden.appendChild(totaldiv);
            divhidden.appendChild(commentparent);
          }
          print_elem();
        }

        function print_elem() {
              var mywindow =window.open('', 'PRINT', 'height=400,width=600');
              mywindow.id = "window"
              var today = new Date();
              var dd = String(today.getDate()).padStart(2, '0');
              var mm = String(today.getMonth() + 1).padStart(2, '0'); //January is 0!
              var yyyy = today.getFullYear();
              today = mm + '/' + dd + '/' + yyyy;
              mywindow.document.write('<html><head><title>' + document.title + "\t Date Created: " + today + '</title>');
              mywindow.document.write(document.getElementById("hiddenImg").innerHTML);
              mywindow.document.write('</head><body>');
              mywindow.document.write('<h1>' + "\n Date Created: \t" +  today + '</h1>' + '<br>'+ '</br>' +'<h1>' + document.title + '</h1>');
              document.getElementById("hiddenDiv").style.display = "show";
              mywindow.document.write(document.getElementById("hiddenDiv").innerHTML);
              document.getElementById("hiddenDiv").style.display = "none";
              mywindow.document.write('</body></html>');
              mywindow.document.close(); // necessary for IE >= 10
              mywindow.focus(); // necessary for IE >= 10
              var hiddenTable = document.getElementById("hiddenTable");
              var hiddenbody = document.getElementById("hiddenbody");
              var totaldiv = document.getElementById("cloneTotaldiv");
              var commentparent = document.getElementById("clonecommentdiv");
              totaldiv.parentNode.removeChild(totaldiv);
              commentparent.parentNode.removeChild(commentparent);
              hiddenbody.parentNode.removeChild(hiddenbody);
              mywindow.print();

              //mywindow.close();
              return false;
        }
        function byeRow(rowid){
          //var rowid = $(this).attr('id');
          var tbody = document.getElementById("myBody");
          var toDelete = document.getElementById("row" + rowid);
          toDelete.parentNode.removeChild(toDelete);
          getTotal();
        };

        function qtyCalc(cellid){
          var pricecolid = "price4" + cellid;
          var costfield = document.getElementById(pricecolid).innerHTML.replace("$","");
          var quantity = document.getElementById("qty4"+ cellid).value;
          var amtID = "amt4" + cellid;
          var qty_availID = "qty_avail4" + cellid;
          var lead_timeID = "lead4" + cellid;
          var lead_time = document.getElementById(lead_timeID);
          var qty_avail = document.getElementById(qty_availID);

          if(isNaN(costfield)){
            document.getElementById("amt4" + cellid).innerHTML = "Contact us";
          } else {
            var total = quantity * costfield;
            total = "$ " + parseFloat(total).toFixed(2);
            document.getElementById("amt4" + cellid).innerHTML = total;
          }
          if (isNaN(quantity)) {
              alert("Quantity Field must be Numeric!");
              document.getElementById("qty4"+ cellid).value = "";
            } else {
              if(parseInt(quantity) > parseInt(qty_avail.innerHTML)) {
                  lead_time.style.visibility = "visible";
                  alert("The Quantity you entered (" + quantity + ") is greater than the Quantity we have on hand (" + qty_avail.innerHTML + ") \n The lead time for this part is: " + lead_time.innerHTML);
                } else{
                  lead_time.style.visibility = "hidden";
                }
            }
            getTotal();
          };
          function getTotal() {
            var FinalTotal = document.getElementById("TotalAmt");
            FinalTotal.innerHTML = "$0.00" ;
            var trs = document.getElementById("myBody").getElementsByTagName("tr");
            var length = trs.length;
            for (var i=0; i < length; i++){

              var linecost = trs[i].cells[5].getElementsByTagName("span")[0].innerHTML.replace("$","");
              Final = parseFloat(FinalTotal.innerHTML.replace("$","")) + parseFloat(linecost);
              FinalTotal.innerHTML = "$" + parseFloat(Final).toFixed(2);
              document.getElementById("myTable2").rows[0].cells[1].innerHTML = "$" + parseFloat(Final).toFixed(2);
            }
          }
          function list_focus() {
            document.getElementById("myPartsList").focus();
          }
          /* function addrowfunction(event) {
            var input = document.getElementById("searchInput");
              if (event.keyCode === 13) {
                event.preventDefault();
                document.getElementById("searchBtn").click();
              }
          } */

    </script>
    </div>
  </body>
</html>
